# Story 1.3: Database Setup & Core Schema

## Status
Draft

## GitHub Tracking
**Issue #3**: https://github.com/RosagerImaging/netpost-v2/issues/3

## Story
**As a** developer building the NetPost V2 platform,
**I want** a complete PostgreSQL database schema with core data models and Supabase configuration,
**so that** the application can store and manage users, inventory items, listings, and marketplace connections with proper relationships and performance optimization.

## Acceptance Criteria

1. Supabase PostgreSQL database is configured and accessible from the application
2. User profiles table extends Supabase Auth with additional reseller-specific fields
3. InventoryItem table supports complete item data including photos, descriptions, and sourcing information
4. Listing table manages cross-platform listing states and marketplace-specific data
5. MarketplaceConnection table handles user authentication tokens for marketplace APIs
6. Database relationships are properly defined with foreign keys and referential integrity
7. Performance indexes are created for common query patterns (user lookups, item searches)
8. Database migration system is established for schema version control
9. TypeScript types are generated from database schema for type safety
10. Database access patterns follow repository pattern for clean separation of concerns

## Tasks / Subtasks

- [ ] **Task 1: Supabase Database Configuration** (AC: 1)
  - [ ] Set up Supabase project database in development environment
  - [ ] Configure database connection strings and environment variables
  - [ ] Test database connectivity from Next.js application
  - [ ] Set up database backup and recovery procedures
  - [ ] Configure Supabase Row Level Security (RLS) policies

- [ ] **Task 2: User Profiles Table** (AC: 2)
  - [ ] Create user_profiles table extending Supabase Auth users
  - [ ] Add reseller-specific fields (business_name, subscription_tier, onboarding_completed)
  - [ ] Implement RLS policies for user data privacy
  - [ ] Create user profile triggers for automatic profile creation
  - [ ] Add user preferences and settings fields

- [ ] **Task 3: InventoryItem Schema** (AC: 3)
  - [ ] Design and create inventory_items table with comprehensive fields
  - [ ] Add support for multiple photos, tags, and categorization
  - [ ] Include sourcing information (location, cost, date_sourced)
  - [ ] Add SKU/barcode support and AI-generated metadata fields
  - [ ] Implement soft delete functionality for data retention

- [ ] **Task 4: Listing Management Schema** (AC: 4)
  - [ ] Create listings table linking inventory items to marketplace listings
  - [ ] Add marketplace-specific fields (marketplace_id, external_listing_id, status)
  - [ ] Include pricing, shipping, and marketplace-specific metadata
  - [ ] Add listing status tracking (draft, active, sold, delisted)
  - [ ] Support for listing variations and marketplace-specific formatting

- [ ] **Task 5: Marketplace Connections** (AC: 5)
  - [ ] Design marketplace_connections table for API credentials
  - [ ] Add encrypted storage for OAuth tokens and API keys
  - [ ] Include marketplace configuration and user preferences
  - [ ] Add connection status and health monitoring fields
  - [ ] Implement token refresh and expiration handling

- [ ] **Task 6: Database Relationships & Constraints** (AC: 6)
  - [ ] Define foreign key relationships between all tables
  - [ ] Add check constraints for data validation
  - [ ] Create composite unique constraints where appropriate
  - [ ] Implement cascade delete policies for data consistency
  - [ ] Add database-level validation rules

- [ ] **Task 7: Performance Optimization** (AC: 7)
  - [ ] Create indexes for user_id lookups across all tables
  - [ ] Add full-text search indexes for inventory item titles/descriptions
  - [ ] Create composite indexes for common query patterns
  - [ ] Add marketplace + status indexes for listing queries
  - [ ] Analyze and optimize query performance

- [ ] **Task 8: Database Migration System** (AC: 8)
  - [ ] Set up Supabase migrations workflow
  - [ ] Create initial migration scripts for all tables
  - [ ] Implement migration rollback capabilities
  - [ ] Add data seeding scripts for development
  - [ ] Document migration procedures and best practices

- [ ] **Task 9: TypeScript Integration** (AC: 9)
  - [ ] Generate TypeScript types from Supabase schema
  - [ ] Create database query helpers with proper typing
  - [ ] Set up automatic type generation workflow
  - [ ] Add type definitions to shared-types package
  - [ ] Validate type safety across frontend and backend

- [ ] **Task 10: Repository Pattern Implementation** (AC: 10)
  - [ ] Create base repository class with common CRUD operations
  - [ ] Implement UserRepository with profile management
  - [ ] Create InventoryItemRepository with search and filtering
  - [ ] Build ListingRepository with marketplace integration
  - [ ] Add MarketplaceConnectionRepository for credential management

## Dev Notes

### Previous Story Context
Story 1.1 established the project foundation and Story 1.2 added Supabase Auth. This story extends the Supabase integration to include the complete database schema needed for the reselling platform.

### Architecture Requirements
[Source: docs/architecture/2-high-level-architecture.md, docs/architecture/9-database-schema.md]
- **Database Platform**: Supabase Managed PostgreSQL in US region
- **Data Models**: User, InventoryItem, Listing, MarketplaceConnection as core entities
- **Repository Pattern**: Backend uses repository pattern for database abstraction
- **Performance**: Real-time data synchronization requirements
- **Integration**: API reads/writes to database, supports both web and mobile apps

### Core Data Models
[Source: docs/architecture/4-data-models.md]
- **User**: Extends Supabase Auth with reseller profile data
- **InventoryItem**: Core inventory management with photos, descriptions, sourcing info
- **Listing**: Cross-platform listing management with marketplace-specific data
- **MarketplaceConnection**: Secure storage of marketplace API credentials and preferences

### Business Requirements Context
[Source: docs/brief.md, docs/prd/2-requirements.md]
- **Multi-Platform**: Support for 3-5 marketplaces (eBay, Poshmark, etc.)
- **Real-Time Sync**: Data synchronization between web and mobile apps
- **Professional Users**: Large inventory management for professional resellers
- **Performance**: Application must feel fast with efficient data access
- **Security**: Secure storage of marketplace credentials and user data

### Database Schema Patterns
```sql
-- Core Tables
user_profiles (extends auth.users)
inventory_items (user_id, title, description, photos[], status, sourcing_data)
listings (inventory_item_id, marketplace_id, external_id, status, pricing)
marketplace_connections (user_id, marketplace_type, credentials_encrypted, status)

-- Key Relationships
user_profiles.id -> inventory_items.user_id
inventory_items.id -> listings.inventory_item_id
user_profiles.id -> marketplace_connections.user_id
```

### Performance Requirements
[Source: docs/brief.md]
- **Real-time synchronization**: Fast data access for mobile and web
- **Search capability**: Full-text search across inventory items
- **Scalability**: Support for professional users with large inventories
- **Query optimization**: Efficient lookups for dashboard and listing views

### Security & Compliance
[Source: docs/architecture/13-security-and-performance.md]
- **RLS Policies**: Row Level Security for multi-tenant data isolation
- **Credential Encryption**: Secure storage of marketplace API tokens
- **Data Privacy**: User data protection and GDPR compliance considerations
- **Audit Trail**: Change tracking for important business data

### File Locations
```
apps/api/
├── database/
│   ├── migrations/
│   │   ├── 001_create_user_profiles.sql
│   │   ├── 002_create_inventory_items.sql
│   │   ├── 003_create_listings.sql
│   │   └── 004_create_marketplace_connections.sql
│   └── repositories/
│       ├── base-repository.ts
│       ├── user-repository.ts
│       ├── inventory-repository.ts
│       ├── listing-repository.ts
│       └── marketplace-repository.ts
packages/shared-types/
├── database/
│   ├── user.ts
│   ├── inventory-item.ts
│   ├── listing.ts
│   └── marketplace-connection.ts
```

### Testing Standards
- **Unit Tests**: Repository classes and database operations
- **Integration Tests**: Database relationships and constraints
- **Performance Tests**: Query optimization and index effectiveness
- **Migration Tests**: Schema changes and data migrations
- **Security Tests**: RLS policies and data access controls

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-14 | 1.0 | Initial story creation for database setup and core schema | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_