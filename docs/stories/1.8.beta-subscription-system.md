# Story 1.8: Beta Subscription System

## Status

Ready

## GitHub Tracking

**Issue #12**: https://github.com/RosagerImaging/netpost-v2/issues/12

## Story

**As a** beta program administrator and future paying user,
**I want** a functional subscription management system with beta testing capabilities,
**so that** beta users can access the platform with proper usage tracking while preparing for paid subscription tiers.

## Acceptance Criteria

1. Beta subscription system allows unlimited access for approved beta testers
2. Subscription tiers are defined (Free Trial, Hobbyist, Pro) with feature restrictions
3. User subscription status is tracked and enforced across the application
4. Billing integration is implemented in test mode (Stripe test environment)
5. Usage metrics are collected for beta users (listings created, items managed, API calls)
6. Admin dashboard shows subscription status and usage analytics for all users
7. Beta users can view their current subscription status and usage statistics
8. System handles subscription transitions (beta to paid, trial to paid, upgrades/downgrades)
9. Feature gating enforces subscription limits on core functionality
10. Email notifications handle subscription events (welcome, usage warnings, billing issues)

## Tasks / Subtasks

- [ ] **Task 1: Subscription Data Model and Database Schema** (AC: 1, 2)
  - [ ] Create subscriptions table with tier definitions
  - [ ] Add user_subscription relationship and current status
  - [ ] Define subscription tiers (Beta, Trial, Hobbyist, Pro) with limits
  - [ ] Create usage_metrics table for tracking user activity
  - [ ] Add subscription history for tier changes and billing events

- [ ] **Task 2: Stripe Integration Setup** (AC: 4)
  - [ ] Set up Stripe test environment with API keys
  - [ ] Create Stripe products and pricing tiers
  - [ ] Implement Stripe webhook handling for subscription events
  - [ ] Add secure webhook signature verification
  - [ ] Create subscription creation and management API endpoints

- [ ] **Task 3: Subscription Service Layer** (AC: 3, 8)
  - [ ] Build subscription service with tier validation
  - [ ] Implement subscription status checking middleware
  - [ ] Add subscription transition logic (upgrades, downgrades, cancellations)
  - [ ] Create usage limit enforcement mechanisms
  - [ ] Handle subscription renewal and billing cycle management

- [ ] **Task 4: Usage Metrics Collection** (AC: 5)
  - [ ] Implement usage tracking for key user actions
  - [ ] Track listings created, items managed, API calls, storage usage
  - [ ] Create metrics aggregation and reporting system
  - [ ] Add real-time usage monitoring and alerts
  - [ ] Implement usage limit warnings and enforcement

- [ ] **Task 5: Feature Gating System** (AC: 9)
  - [ ] Create feature flag system based on subscription tiers
  - [ ] Implement usage limits for each subscription tier
  - [ ] Add feature access checking throughout the application
  - [ ] Create upgrade prompts when limits are reached
  - [ ] Handle graceful degradation for over-limit scenarios

- [ ] **Task 6: User Subscription Dashboard** (AC: 7)
  - [ ] Build subscription status page for users
  - [ ] Display current tier, usage statistics, and billing information
  - [ ] Add subscription management actions (upgrade, cancel, update payment)
  - [ ] Show usage trends and approaching limits
  - [ ] Create billing history and invoice access

- [ ] **Task 7: Admin Subscription Dashboard** (AC: 6)
  - [ ] Create admin interface for subscription management
  - [ ] Display all user subscriptions with status and usage analytics
  - [ ] Add admin actions for subscription overrides and adjustments
  - [ ] Create subscription performance metrics and reports
  - [ ] Implement user search and filtering by subscription status

- [ ] **Task 8: Email Notification System** (AC: 10)
  - [ ] Set up email service for subscription notifications
  - [ ] Create email templates for subscription events
  - [ ] Implement welcome emails for new subscribers
  - [ ] Add usage warning emails when approaching limits
  - [ ] Create billing notification emails for payment issues

- [ ] **Task 9: Beta User Management** (AC: 1)
  - [ ] Create beta user invitation and approval system
  - [ ] Implement beta access code or invitation link system
  - [ ] Add beta user onboarding flow with platform introduction
  - [ ] Create beta feedback collection mechanisms
  - [ ] Handle beta-to-paid transition workflows

- [ ] **Task 10: Testing and Quality Assurance** (AC: 1-10)
  - [ ] Create comprehensive unit tests for subscription logic
  - [ ] Build integration tests with Stripe test environment
  - [ ] Add end-to-end testing for subscription workflows
  - [ ] Test feature gating and usage limit enforcement
  - [ ] Create load testing for subscription system performance

## Dev Notes

### Previous Story Context

Stories 1.1-1.7 established the complete core platform functionality including sourcing, inventory management, cross-listing, and automated de-listing. This story adds the business layer with subscription management and usage tracking to prepare for monetization.

### Architecture Requirements

[Source: docs/brief.md, docs/architecture/2-high-level-architecture.md]

- **Payment Processing**: Stripe integration for subscription billing
- **Feature Gating**: Middleware-based access control throughout application
- **Usage Tracking**: Comprehensive metrics collection and aggregation
- **Admin Tools**: Dashboard for subscription and user management

### Business Model Integration

[Source: docs/brief.md - MVP Scope section]

- **Beta Program**: Free unlimited access for approved beta testers
- **Subscription Tiers**: Free trial, Hobbyist ($X/month), Pro ($Y/month)
- **Feature Differentiation**: Usage limits and advanced features by tier
- **Billing System**: Functional billing system in test mode for beta

### Subscription Tier Definitions

[Source: docs/brief.md - Target Users section]

**Beta Tier (Free during beta period):**
- Unlimited listings and inventory management
- All marketplace integrations
- Full AI assistant access
- Priority support during beta

**Free Trial (Post-launch):**
- 30-day trial with full Pro features
- Limited to 50 inventory items
- 3 marketplace connections
- Basic support

**Hobbyist Tier ($9.99/month):**
- Up to 200 inventory items
- 3 marketplace connections
- Basic cross-listing and de-listing
- Standard support

**Pro Tier ($29.99/month):**
- Unlimited inventory items
- All marketplace integrations
- Full AI assistant suite
- Priority support

### Data Model Integration

[Source: docs/architecture/4-data-models.md, Story 1.3 context]

**Subscription Schema:**
```sql
subscriptions (
  id, user_id, stripe_subscription_id,
  tier, status, -- beta, trial, active, past_due, cancelled
  current_period_start, current_period_end,
  trial_start, trial_end,
  created_at, updated_at
)

usage_metrics (
  id, user_id, metric_type,
  value, period_start, period_end,
  created_at
)

subscription_limits (
  id, tier, feature_name,
  limit_value, limit_type -- count, boolean, usage
)
```

### Feature Gating Implementation

**Middleware Approach:**
- Subscription checking middleware for API routes
- React context for frontend feature access
- Database queries optimized with subscription status caching
- Graceful degradation when limits are exceeded

**Key Features to Gate:**
- Inventory item limits
- Marketplace connection limits
- API rate limits
- Advanced AI features
- Priority support access

### File Locations

```
apps/web/src/
├── app/(dashboard)/
│   ├── subscription/
│   │   ├── page.tsx                    # User subscription dashboard
│   │   ├── manage/
│   │   │   └── page.tsx               # Subscription management
│   │   └── components/
│   │       ├── SubscriptionStatus.tsx # Current tier display
│   │       ├── UsageMetrics.tsx       # Usage statistics
│   │       ├── BillingHistory.tsx     # Payment history
│   │       └── UpgradePrompt.tsx      # Upgrade suggestions
│   ├── admin/
│   │   ├── subscriptions/
│   │   │   └── page.tsx               # Admin subscription dashboard
│   │   └── components/
│   │       └── UserSubscriptions.tsx  # Admin user management
├── lib/
│   ├── subscription/
│   │   ├── subscription-service.ts    # Core subscription logic
│   │   ├── stripe-service.ts          # Stripe integration
│   │   ├── usage-tracker.ts           # Usage metrics collection
│   │   ├── feature-gates.ts           # Feature access control
│   │   └── notification-service.ts    # Subscription notifications
│   └── middleware/
│       └── subscription-middleware.ts # Route-level subscription checks

apps/api/
├── routes/
│   ├── subscriptions/                 # Subscription management endpoints
│   ├── billing/                       # Billing and payment endpoints
│   ├── webhooks/
│   │   └── stripe.ts                 # Stripe webhook handling
│   └── admin/
│       └── subscriptions.ts           # Admin subscription endpoints
└── services/
    ├── subscription-service.ts        # Subscription business logic
    ├── billing-service.ts             # Billing and payment processing
    └── usage-service.ts               # Usage tracking and limits
```

### Stripe Integration Requirements

- **Test Environment**: All billing in Stripe test mode during beta
- **Webhook Security**: Proper signature verification for Stripe events
- **Subscription Events**: Handle creation, updates, cancellations, payment failures
- **Customer Portal**: Stripe customer portal for self-service billing management

### Usage Metrics to Track

- **Inventory Management**: Items added, photos uploaded, storage used
- **Listing Activity**: Listings created, marketplaces connected, API calls
- **User Engagement**: Login frequency, feature usage, support requests
- **Performance Metrics**: Response times, error rates, system health

### Testing Standards

- **Unit Tests**: Subscription logic, feature gating, usage tracking
- **Integration Tests**: Stripe integration, webhook handling, database operations
- **E2E Tests**: Complete subscription flows, billing workflows
- **Load Tests**: Usage tracking performance, subscription checks at scale
- **Security Tests**: Payment data handling, webhook security
- **Test Location**: `apps/web/src/lib/subscription/**/*.test.ts`

### Security Considerations

- **PCI Compliance**: No direct card data handling (Stripe handles all payment data)
- **Webhook Security**: Stripe signature verification for all webhook events
- **API Security**: Authenticated access to all subscription endpoints
- **Data Privacy**: Secure handling of billing information and usage data

### Email Notification Templates

- **Welcome Email**: Beta invitation and platform introduction
- **Usage Warning**: Approaching tier limits with upgrade suggestions
- **Billing Issues**: Payment failures and resolution steps
- **Subscription Changes**: Confirmations for upgrades, downgrades, cancellations
- **Beta Feedback**: Requests for user feedback and feature suggestions

## Change Log

| Date       | Version | Description                                           | Author             |
| ---------- | ------- | ----------------------------------------------------- | ------------------ |
| 2025-09-16 | 1.0     | Initial story creation for beta subscription system | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA agent after story completion_